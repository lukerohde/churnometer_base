<div class="container">

  <h1>churnobyl prototype</h1>
  <%= erb :'summary/filter_form' %>
</div>

<section id="data">
	<div id="card_target">
		<% if leader? && params['column'].to_s == '' %>
			<%= "We grew by #{data_sql.growth(@data)}% p.a." %><br/>
			<%="#{data_sql.get_cards_in(@data)} cards brought in per week. " %>
			<%= "#{data_sql.get_cards_in_target(@data)} needed to hold our ground. " %>
			<%= " #{data_sql.get_cards_in_growth_target(@data)} needed to grow 10%." %>
		<% end %>
	</div>
	<div id="card_target_tip" class="tooltip">
		The formula to hold our ground is calculated as 
			'<%= col_names['paying_real_loss'] %>' 
			+ '<%= col_names['a1p_to_other'] %>'
			- the people who resume paying without giving us a card ( i.e. '<%= col_names['paying_real_gain'] %>' - '<%= col_names['a1p_to_paying'] %>'  ) 
			averaged over just the period of time selected.
	</div>
	<div id="tabs">
		
		<ul>
			<% i = 0 %>
			
			<% if waterfall_chart_ok? || line_chart_ok? %>
				<li><a href="#tabs-graph">Graph</a></li>
			<% end %>
			<% tables.each do | table | %>
				<li><a href="#tabs-<%=i+=1%>"><%=table[0] %></a></li>
			<% end %>
			
			<li><a href="#tabs-<%=i+=1%>">Diagnostics</a></li>
		</ul>
	
		<% i = 0 %>

    <% if waterfall_chart_ok? || line_chart_ok? %>
      <%= erb :'summary/graph', :locals => {:i => i} %>
    <% end %>
		
		
		<% tables.each do | table, cols | %>
			<div id="tabs-<%=i+=1%>">
				
			<% if has_data? %>
				<ul>
			    	<% if data_sql.query['column'].empty? %>
				    	<li class="nav"><a href="/export_summary?<%= (query_string || '') + "&table=" + table %>" class="button">Export Summary</a></li>
				    <% else %>
				    	<li class="nav"><a href="/export_member_details?<%= (query_string || '') + "&table=" + table %>" class="button">Export Member Details</a></li>
					<% end %>
				</ul>
			    <% totals = {} %>
 
			    <table class="tablesorter" id='table<%=table %>'>
			      <thead>
			        <tr>
			          <% merge_cols(@data[0], cols).each do |column_name, v| %>
				    	<th id="<%=column_name %>h<%=i%>">
							
							<% if bold_col?(column_name) %> 
								<strong>
							<% end %>
							
							<%= col_names[column_name] || column_name %>
							
							<% if bold_col?(column_name) %> 
								</strong>
							<% end %>
						</th>
			          <% end %>
			        </tr>
			      </thead>
			      <tbody>
			        <% @data.each do |row| %>
			          <tr>
			            <% merge_cols(row, cols).each do |column_name, v| %>
							<%
							  totals[column_name] ||= 0
							  totals[column_name] = safe_add totals[column_name], v
							%>
							<td>
								<% if bold_col?(column_name) %> 
									<strong>
								<% end %>
		
							  		<% if column_name == 'row_header1' %>
									    <a href="<%= drill_down_link_header(row) %>"><%= v %></a>
									<% elsif column_name == 'period_header' %>
										<a href="<%= drill_down_link_interval(row) %>"><%= v %></a>
									<% elsif can_detail_cell? column_name, v %>
									    <a href="<%= detail_cell(row, column_name) %>"><%= v %></a>
									<% elsif can_export_cell? column_name, v %>
									    <a href="<%= export_cell(row, column_name) %>"><%= v %></a>
									<% else %>
									    <%= v %>
									<% end %>
								<% if bold_col?(column_name) %> 
									<strong>
								<% end %>
							</td>
			            <% end %>
			          </tr>
			        <% end %>
			      </tbody>
				  <% if params['column'].to_s == '' %>
			      	<tfoot>
				        <tr>
				          <% totals.each do |column_name, total| %>
				            <td>
								<% if bold_col?(column_name) %> 
									<strong>
								<% end %>
		
					      		<% if !no_total.include?(column_name) %>
				                	<% if can_export_cell? column_name, total %>
					                  <a href="<%= export_column(column_name) %>"><%= total %></a>
					                <% else %>
					                  <%= total %>
					                <% end %>
					            <% end %>
							<% if bold_col?(column_name) %> 
								<strong>
							<% end %>
					    </td>
				          <% end %>
				        </tr>
				      </tfoot>
					<% end %>
			    </table>
	
			  <% else %>
			    <p>No data</p>
			  <% end %>
	
	
			</div>
		<% end %>
		
		<div id="tabs-<%=i+=1%>">
			<ul>
		    	<li class="nav"><a href="/export_summary?<%= query_string %>" class="button">Export All Summary Data</a></li>
		    	<li class="nav"><a href="/export_member_details?<%= query_string %>" class="button">Export All Member Details</a></li>
			</ul>
			
			<pre>
		      <%= h @sql %>
		    </pre>
		</div>
		
		<!-- tooltip descriptions -->
		<% i=0 %> 
		<% if waterfall_chart_ok? || line_chart_ok? %>
			<% i+=1 %>
		<% end %> 
		
		<% tables.each do | table, cols | %>
			<% i+=1 %>
			<% merge_cols(@data[0], cols).each do |column_name, v| %>
				<% if (tips[column_name] || "") != "" %>
					<div id="<%=column_name %>tip<%=i %>" class="tooltip">
						<%=tips[column_name]%>
					</div>
				<% end %>
			<% end %>
		<% end %>
		
	</div>
	
	
</section>




<script>
	<% if (line_chart_ok?) %>
	
		var chart;
		function setupchart() {
		   chart = new Highcharts.Chart({
		      chart: {
		         renderTo: 'chart',
		         defaultSeriesType: 'line',
		         marginRight: 130,
		         marginBottom: 130,
				 height: 500
		      },
		      title: {
		         text: 'Net Paying',
		         x: -20 //center
		      },
		      subtitle: {
		         text: 'Gain and Decline',
		         x: -20
		      },
		      xAxis: {
		         categories: [
					<%= data_sql.periods(@data).collect { | k | "'#{k[0]}'"}.join(",") %>
				] ,
				labels: {
				            rotation: -45,
				            align: 'right',
				         }
		      },
		      yAxis: {
		         title: {
		            text: "<%= col_names['row_header1'] %>"
		         },
		         plotLines: [{
		            value: 0,
		            width: 1,
		            color: '#808080'
		         }]
		      },
		
			plotOptions: {
												         series: {
												            cursor: 'pointer',
												            point: {
												               events: {
												                  click: function() {
																  	
																	window.location = "<%=request.url %>" + this.id;
												                     // chart.htmlExpand(null, {
												                     // 												                        pageOrigin: {
												                     // 												                           x: this.pageX, 
												                     // 												                           y: this.pageY
												                     // 												                        },
												                     // 												                        headingText: this.series.name,
												                     // 												                        maincontentText: Highcharts.dateFormat('%A, %b %e, %Y', this.x) +':<br/> '+ 
												                     // 												                           this.y +' visits',
												                     // 												                        width: 200
												                     // 												                     });
												                  }
												               }
												            }
												         }},
									
									
			
		      tooltip: {
		         formatter: function() {
		                   return '<b>'+ this.series.name +'</b><br/>'+
		               this.x +': '+ this.y;
		         }
		      },
		      legend: {
		         layout: 'vertical',
		         align: 'right',
		         verticalAlign: 'top',
		         x: -10,
		         y: 100,
		         borderWidth: 0
		      },
			  series: [
				<%= data_sql.pivot(@data).collect { | k, v | "{ name: '#{h(k)}', data: [#{v.collect{ | i | i }.join(',')}] }" }.join(",\n") %>
			
				]
		   });
		};
	<% end %>

	$(function() {
		$(".datepicker input").datepicker({dateFormat: 'yy-mm-dd'});
  		
		$("table").tablesorter();
		
		$("#tabs").tabs();
		
		$('#tabs').bind('tabsshow', function(event, ui) {
			$('.floatHeader').hide(); // necessary otherwise a retarded floating table header appears until you scroll
		});
		
		<% tables.each do | table, cols | %>
			$('#table<%=table %>').floatHeader( { recalculate: true, fadeIn:0 }); // recalculate is needed to work with tabs but causes high cpu
		<% end %>
		
		
		<% if (data_sql.series_count(@data) <= 40) %>
			<% if (data_sql.query['interval'] != 'none') %>
				setupchart();
			<% else %>
					$("#waterfall").charts({ charttype: "waterfall", direction: "vertical", labelcolumn: 0, valuecolumn: 1, chartbgcolours: ["#336699", "#669933", "993333"], chartfgcolours: ["#FFFFFF", "#FFFFFF", "#FFFFFF"] });

			<% end %>
		<% end %>
		
		
		// setup tooltip for a single DIV element
		<% i=0 %> 
		<% if waterfall_chart_ok? || line_chart_ok? %>
			<% i+=1 %>
		<% end %> /* skip first tab because it is graphs */ 
		
		<% tables.each do | table, cols | %>
			<% i+=1 %>
			<% merge_cols(@data[0], cols).each do |column_name, v| %>
				<% if (tips[column_name] || "") != "" %>
					$("#<%=column_name %>h<%=i%>").tooltip({
						tip: '#<%=column_name %>tip<%=i %>',
						position: 'center right',
						offset: [-25, 0],
						delay: 0,
						relative: true
					});
				<% end %>
			<% end %>
		<% end %>
		
		$("#card_target").tooltip({
			tip: '#card_target_tip',
			position: 'top center',
			delay: 0,
			relative: false
		});
		
		$(".remove_filter").tooltip({
			tip: '#removefiltertip',
			position: 'center right',
			offset: [25, 50],
			delay: 0,
			relative: true
		});
		
		$(".disable_filter").tooltip({
			tip: '#disablefiltertip',
			position: 'center right',
			offset: [25, 50],
			delay: 0,
			relative: true
		});
		
		$(".invert_filter").tooltip({
			tip: '#invertfiltertip',
			position: 'center right',
			offset: [25, 50],
			delay: 0,
			relative: true
		});
			
		$(".constrain_filter").tooltip({
			tip: '#constrainfiltertip',
			position: 'center right',
			offset: [0, 50],
			delay: 0,
			relative: true
		});
  	});



</script>
