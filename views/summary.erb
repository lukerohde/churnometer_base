<div class="container">

  <h1>churnobyl prototype</h1>
	
	
  <div class="span-24 last">
    <section class="form span-18">
      <form action="/">
	  <% (params[Filter] || []).each do |column_name, value| %>
	    <input type="hidden" name="<%= "#{Filter}[#{column_name}]" %>" value="<%= value %>">
  	    <input type="hidden" name="<%= "#{FilterNames}[#{value}]" %>" value="<%= (params[FilterNames])[value] %>">
	  <% end %>
	  <input type="hidden" name="column" value="<%= @query['column'] %>">
        
        <ul>
          <li class="datepicker span-5">
            <label>Start Date</label>
            <input type="text" name="startDate" value="<%= @query['startDate'] %>">
          </li>
          <li class="datepicker span-5">
            <label>End Date</label>
            <input type="text" name="endDate" value="<%= @query['endDate'] %>">
          </li>
          <li class="group_by span-5">
            <label>Sub-total</label>
            <select name="group_by">
              <% groups_by_collection.each do |column_name, name| %>
                <% if column_name == @query['group_by'] %>
                  <option value="<%= column_name %>" selected="selected"><%= name %></option>
                <% else %>
                  <option value="<%= column_name %>"><%= name %></option>
                <% end %>
              <% end %>
            </select>
		  </li>
		  <li class="group_by span-5 last">
            <label>Time Interval</label>
            <select name="interval">
              <% interval_collection.each do |column_name, name| %>
                <% if column_name == @query['interval'] %>
                  <option value="<%= column_name %>" selected="selected"><%= name %></option>
                <% else %>
                  <option value="<%= column_name %>"><%= name %></option>
                <% end %>
              <% end %>
            </select>
		  </li>
        </ul>
        <ul>
          <li><input type="submit" value="Refresh"></li>
        </ul>
      </form>
    </section>
 </div>
 <div>
    <section id="filter">
      <h2>Selections</h2>
      <ul>
	<li>
	  <strong><%= @query['startDate'] %> &nbsp;&nbsp;to&nbsp;&nbsp; <%= @query['endDate'] %></strong>
	</li>
	<% if !@warning.nil? %>
	  <li><%= @warning %></li>
	<% end %>
	<% if filter_names.count == 0 %>
	  <li>Nothing selected </li>
	<% end %>
        <% filter_names.each do |filter_value, filter_name| %>
          <li><strong><%= filter_name %></strong> <a href="<%= remove_filter_link(filter_value) %>">remove</a></li>
        <% end %>
        <% if !@query['column'].empty? %>
	  <li><strong><%= @query['column'] %></li>
	<% end %>
      </ul>
    </section>
 </div>
</div>
<section>
	<div id="chart">
	<% if query['interval'] != 'none' %>
		LINE GRAPH GOES HERE
	<% else %>
	  <% if @data.count <= 20 %>
	  	<table id="waterfall">
			<caption>Paying gain vs loss</caption>
			<thead>
				<tr>
					<th>Item</th>
					<th>Change</th>
				</tr>

			</thead>
			<tfoot>
				<tr>
					<td>End Difference</td>
					<td><%= paying_end_total(@data) - paying_end_total(@data)%></td>
				</tr>
			</tfoot>
			<tbody>
				<tr>
						<td></td>
						<td>0</td>
				</tr>
				<% @data.each do |row| %>
		            <tr>
						<td><%= "#{row['row_header1']} gain" %></td>
						<td><%= row['paying_real_gain'] %></td>
					</tr>
					<tr>
						<td><%= "#{row['row_header1']} loss" %></td>
						<td><%= row['paying_real_loss'] %></td>
					</tr>
				<% end %>
				<tr>
						<td></td>
						<td><%= paying_end_total(@data) - paying_end_total(@data)%> </td>
				</tr>
			</tbody>
		</table>
	  <% end %>
	<% end %>
	<div>
</section>
<section id="data">
  <h2>Data</h2>
  <ul>
    <% if @query['column'].empty? %>
      <li><a href="/export_summary?<%= query_string %>" class="button">Export Summary</a></li>
    <% end %>
    <li><a href="/export_member_details?<%= query_string %>" class="button">Export Member Details</a></li>
    <li><a id='toggle' onclick="$('.advcol').toggle();if ($('#toggle').text()=='Show more') $('#toggle').text('Show less'); else $('#toggle').text('Show more');">Show more</a></li>
 </p>
  <% if has_data? %>
    <%
      totals = {}
    %>
  
    <table class="tablesorter">
      <thead>
        <tr>
          <% @data[0].each do |column_name, v| %>
	    	<th <%= show_col?(column_name) ? '' : 'class="advcol"' %> id="<%=column_name %>head">
				<% if bold_col?(column_name) %> 
					<strong>
				<% end %>
					<%= col_names[column_name] || column_name %>
				<% if bold_col?(column_name) %> 
					</strong>
				<% end %>
			</th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @data.each do |row| %>
          <tr>
            <% row.each do |column_name, v| %>
		<%
		  totals[column_name] ||= 0
		  totals[column_name] = safe_add totals[column_name], v
		%>
		<td <%= show_col?(column_name) ? '' : 'class="advcol"' %>>
			<% if bold_col?(column_name) %> 
				<strong>
			<% end %>
			
		  		<% if column_name == 'row_header1' %>
				    <a href="<%= drill_down_link(row) %>"><%= v %></a>
				  <% elsif can_detail_cell? column_name, v %>
				    <a href="<%= detail_cell(row, column_name) %>"><%= v %></a>
				  <% elsif can_export_cell? column_name, v %>
				    <a href="<%= export_cell(row, column_name) %>"><%= v %></a>
				  <% else %>
				    <%= v %>
				<% end %>
			<% if bold_col?(column_name) %> 
				<strong>
			<% end %>
		</td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr>
          <% totals.each do |column_name, total| %>
            <td <%= show_col?(column_name) ? '' : 'class="advcol"' %>>
				<% if bold_col?(column_name) %> 
					<strong>
				<% end %>
			
	      		<% if !no_total.include?(column_name) %>
                	<% if can_export_cell? column_name, total %>
	                  <a href="<%= export_column(column_name) %>"><%= total %></a>
	                <% else %>
	                  <%= total %>
	                <% end %>
	            <% end %>
			<% if bold_col?(column_name) %> 
				<strong>
			<% end %>
	    </td>
          <% end %>
        </tr>
      </tfoot>
    </table>
  <% else %>
    <p>No data</p>
  <% end %>
</section>
<div class="container">
  <section>
    <h2>SQL sent</h2>
    <pre>
      <%= h @sql %>
    </pre>
  </section>
</div>

<% @data[0].each do | column_name, v | %>
	<% if (tips[column_name] || "") != "" %>
		<div id="<%=column_name %>tip" class="tooltip">
			<%=tips[column_name]%>
		</div>
	<% end %>
<% end %>




<script>
	var chart;
	function setupchart() {
	   chart = new Highcharts.Chart({
	      chart: {
	         renderTo: 'chart',
	         defaultSeriesType: 'line',
	         marginRight: 130,
	         marginBottom: 130
	      },
	      title: {
	         text: 'Net Paying',
	         x: -20 //center
	      },
	      subtitle: {
	         text: 'Gain and Decline',
	         x: -20
	      },
	      xAxis: {
	         categories: [
				<%= periods(@data).collect { | k | "'#{k[0]}'"}.join(",") %>
			] ,
			labels: {
			            rotation: -45,
			            align: 'right',
			         }
	      },
	      yAxis: {
	         title: {
	            text: "<%= col_names['row_header1'] %>"
	         },
	         plotLines: [{
	            value: 0,
	            width: 1,
	            color: '#808080'
	         }]
	      },
	      tooltip: {
	         formatter: function() {
	                   return '<b>'+ this.series.name +'</b><br/>'+
	               this.x +': '+ this.y;
	         }
	      },
	      legend: {
	         layout: 'vertical',
	         align: 'right',
	         verticalAlign: 'top',
	         x: -10,
	         y: 100,
	         borderWidth: 0
	      },
		  series: [
			<%= pivot(@data).collect { | k, v | "{ name: '#{k}', data: [#{v.collect{ | i | i}.join(',')}] }" }.join(",\n") %>
		  ]
	   });
   
   
	};

	$(function() {
  		$(".datepicker input").datepicker({dateFormat: 'yy-mm-dd'});
  		$("table").tablesorter();
		$(".advcol").hide();
		// setup tooltip for a single DIV element
		<% @data[0].each do | column_name, v | %>
			<% if (tips[column_name] || "") != "" %>
		
				$("#<%=column_name %>head").tooltip({
					tip: '#<%=column_name %>tip',
					position: 'top center',
					offset: [-25, 0],
					delay: 0
				});
				
			<% end %>
		<% end %>
		
		<% if (query['interval'] != 'none') %>
			setupchart();
		<% else %>
			<% if (@data.count <= 20) %>
				$("#waterfall").charts({ charttype: "waterfall", direction: "vertical", labelcolumn: 0, valuecolumn: 1, chartbgcolours: ["#FFFFFF", "#669933", "993333"], chartfgcolours: ["#FFFFFF", "#FFFFFF", "#FFFFFF"] });
			<% end %>
		<% end %>
  	});
</script>
